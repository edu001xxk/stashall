name: "Cloudflare è‡ªåŠ¨ä¼˜é€‰ (ä¿åº•ç‰ˆ)"
desc: "å¼ºåˆ¶ç”ŸæˆèŠ‚ç‚¹ï¼Œä¿®å¤0èŠ‚ç‚¹é—®é¢˜"

# ==================================
# 1. é¦–é¡µç£è´´ (è´Ÿè´£æµ‹é€Ÿ + å†™å…¥)
# ==================================
tiles:
  - name: CF-Speedtest
    title: Cloudflare å››ç½‘ä¼˜é€‰
    content: ç‚¹å‡»è¿è¡Œæµ‹é€Ÿ
    icon: network
    collapsed: false

script-providers:
  CF-Speedtest:
    interval: 0
    # ä½¿ç”¨ fastly CDN ä½œä¸ºæ¡æ‰‹é“¾æ¥ï¼Œå›½å†…æé€Ÿ
    url: "https://fastly.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
    
    content: |
      const url = "https://api.uouin.com/index.php/index/Cloudflare?key=123&time=" + Date.now();
      
      function getBest(list) {
          if(!list) return null;
          let v = list.filter(i => i.loss === "0.00%");
          if(v.length===0) return list[0];
          v.sort((a,b) => parseFloat(a.ping) - parseFloat(b.ping));
          return v[0];
      }

      $httpClient.get({url: url, timeout: 15000}, function(error, response, data) {
          if (error) { 
              $done({title:"å¤±è´¥", content:"ç½‘ç»œé”™è¯¯", backgroundColor:"#FF3B30"}); 
              return; 
          }
          try {
              let d = JSON.parse(data).data;
              let cm = getBest(d.cmcc?.info);
              let ct = getBest(d.ctcc?.info);
              let cu = getBest(d.cucc?.info);
              let v6 = getBest(d.ipv6?.info);
              
              // å†™å…¥å­˜å‚¨
              if(cm) $persistentStore.write(cm.ip, "CF_IP_CM");
              if(ct) $persistentStore.write(ct.ip, "CF_IP_CT");
              if(cu) $persistentStore.write(cu.ip, "CF_IP_CU");
              if(v6) $persistentStore.write(v6.ip, "CF_IP_V6");
              
              let txt = "æ›´æ–°æˆåŠŸ\n";
              if(cm) txt += `ç§»:${cm.ip}\n`;
              if(ct) txt += `ç”µ:${ct.ip}\n`;
              if(v6) txt += `v6:${v6.ip.substring(0,10)}..`;
              
              $done({title:"ä¼˜é€‰å®Œæˆ", content: txt, backgroundColor:"#34C759", icon:"checkmark"});
          } catch(e) { 
              $done({title:"é”™è¯¯", content: "è§£æå¤±è´¥", backgroundColor:"#FF3B30"}); 
          }
      });

# ==================================
# 2. èŠ‚ç‚¹ç”Ÿæˆ (è¯»å– & å¼ºåˆ¶ç”Ÿæˆ)
# ==================================
proxy-providers:
  CF-Auto-Nodes:
    type: script
    interval: 300
    health-check: {enable: true, url: http://www.gstatic.com/generate_204, interval: 300}
    # åŒæ ·ä½¿ç”¨ fastly CDN éª—è¿‡æ ¡éªŒ
    url: "https://fastly.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"
    
    content: |
      // 1. å®šä¹‰ä¿åº•é»˜è®¤å€¼ (é˜²æ­¢è¯»å–å¤±è´¥)
      var def = "cf.zhetengsha.eu.org";
      
      // 2. å°è¯•è¯»å–ï¼Œå¦‚æœè¯»ä¸åˆ°å°±ç”¨é»˜è®¤å€¼
      var cm = $persistentStore.read("CF_IP_CM");
      var ct = $persistentStore.read("CF_IP_CT");
      var cu = $persistentStore.read("CF_IP_CU");
      var v6 = $persistentStore.read("CF_IP_V6");

      if(!cm) cm = def;
      if(!ct) ct = def;
      if(!cu) cu = def;
      if(!v6) v6 = def;

      // 3. ä½ çš„é…ç½®
      var uuid = "87d1bfd4-574e-4c96-ad42-0426f27461ff";
      var host = "_acme-challenge.2go.cloudns.be";
      var path = "/?ed=2560";

      // 4. ç”Ÿæˆå‡½æ•°
      function createProxy(name, ip) {
          var finalIP = ip;
          if (ip.indexOf(":") > -1 && ip.indexOf("[") === -1) finalIP = "[" + ip + "]";
          
          return {
              "name": name,
              "type": "vless",
              "server": finalIP,
              "port": 443,
              "uuid": uuid,
              "tls": true,
              "skip-cert-verify": true,
              "servername": host,
              "network": "ws",
              "ws-opts": { "path": path, "headers": { "Host": host } },
              "udp": true
          };
      }

      // 5. å¼ºåˆ¶è¾“å‡º 4 ä¸ªèŠ‚ç‚¹
      $done({
          proxies: [
              createProxy("ğŸ“± ç§»åŠ¨ | " + cm, cm),
              createProxy("ğŸŒ ç”µä¿¡ | " + ct, ct),
              createProxy("ğŸ“¶ è”é€š | " + cu, cu),
              createProxy("ğŸ¦• IPv6 | " + v6, v6)
          ]
      });

# ==================================
# 3. ç­–ç•¥ç»„
# ==================================
proxy-groups:
  - name: "ğŸš€ è‡ªåŠ¨ä¼˜é€‰"
    type: select
    use:
      - CF-Auto-Nodes

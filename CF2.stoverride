name: "CFä¼˜é€‰ (CDNå†…åµŒç‰ˆ)"
desc: "è§£å†³æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶å’Œç½‘ç»œä¸‹è½½å¤±è´¥çš„é—®é¢˜"

# ==================================
# 1. é¦–é¡µç£è´´ (UI & æµ‹é€Ÿ)
# ==================================
tiles:
  - name: CF-Speedtest
    title: Cloudflare å››ç½‘ä¼˜é€‰
    content: ç‚¹å‡»è¿è¡Œæµ‹é€Ÿ
    icon: network
    collapsed: false

script-providers:
  CF-Speedtest:
    interval: 0
    # ğŸ‘‡ è¿™é‡Œçš„ URL åªæ˜¯ä¸ªå¹Œå­ï¼Œä¸ºäº†æ»¡è¶³æ ¼å¼è¦æ±‚
    url: "https://fastly.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
    
    # ğŸ‘‡ çœŸæ­£çš„ä»£ç åœ¨è¿™é‡Œ (ç›´æ¥å†…åµŒ)
    content: |
      const url = "https://api.uouin.com/index.php/index/Cloudflare?key=123&time=" + Date.now();
      
      function getBest(list) {
          if(!list) return null;
          let v = list.filter(i => i.loss === "0.00%");
          if(v.length===0) return list[0];
          v.sort((a,b) => parseFloat(a.ping) - parseFloat(b.ping));
          return v[0];
      }

      $httpClient.get({url: url, timeout: 15000}, function(error, response, data) {
          if (error) { $done({title:"å¤±è´¥", content:"ç½‘ç»œé”™è¯¯", backgroundColor:"#FF3B30"}); return; }
          try {
              let d = JSON.parse(data).data;
              let cm = getBest(d.cmcc?.info);
              let ct = getBest(d.ctcc?.info);
              let cu = getBest(d.cucc?.info);
              let v6 = getBest(d.ipv6?.info);
              
              // ä¿å­˜ IP åˆ°ç³»ç»Ÿå­˜å‚¨
              if(cm) $persistentStore.write(cm.ip, "CF_IP_CM");
              if(ct) $persistentStore.write(ct.ip, "CF_IP_CT");
              if(cu) $persistentStore.write(cu.ip, "CF_IP_CU");
              if(v6) $persistentStore.write(v6.ip, "CF_IP_V6");
              
              let txt = "";
              if(cm) txt += `ğŸ“± ${cm.ip}\n`;
              if(ct) txt += `ğŸŒ ${ct.ip}\n`;
              if(cu) txt += `ğŸ“¶ ${cu.ip}\n`;
              if(v6) txt += `ğŸ¦• ${v6.ip.substring(0,13)}..`;
              
              $done({title:"ä¼˜é€‰å®Œæˆ", content: txt, backgroundColor:"#34C759", icon:"checkmark"});
          } catch(e) { $done({title:"é”™è¯¯", content: "è§£æå¤±è´¥", backgroundColor:"#FF3B30"}); }
      });

# ==================================
# 2. è‡ªåŠ¨èŠ‚ç‚¹ç”Ÿæˆ (è¯»å– & ç”Ÿæˆ)
# ==================================
proxy-providers:
  CF-Auto-Nodes:
    type: script
    interval: 300
    health-check: {enable: true, url: http://www.gstatic.com/generate_204, interval: 300}
    # ğŸ‘‡ åŒæ ·æ˜¯ä¸€ä¸ªèƒ½ç§’ä¸‹è½½çš„å‡ URL
    url: "https://fastly.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"
    
    # ğŸ‘‡ çœŸæ­£çš„èŠ‚ç‚¹ç”Ÿæˆä»£ç 
    content: |
      // 1. è¯»å–æ•°æ®
      var def = "cf.zhetengsha.eu.org";
      var cm = $persistentStore.read("CF_IP_CM") || def;
      var ct = $persistentStore.read("CF_IP_CT") || def;
      var cu = $persistentStore.read("CF_IP_CU") || def;
      var v6 = $persistentStore.read("CF_IP_V6") || def;

      // 2. ä½ çš„ VLESS é…ç½®
      var uuid = "87d1bfd4-574e-4c96-ad42-0426f27461ff";
      var host = "_acme-challenge.2go.cloudns.be";
      var path = "/?ed=2560";

      // 3. ç”ŸæˆèŠ‚ç‚¹å‡½æ•°
      function createProxy(name, ip) {
          var finalIP = ip;
          // IPv6 å¿…é¡»åŠ  []
          if (ip.indexOf(":") > -1 && ip.indexOf("[") === -1) finalIP = "[" + ip + "]";
          
          return {
              "name": name,
              "type": "vless",
              "server": finalIP,
              "port": 443,
              "uuid": uuid,
              "tls": true,
              "skip-cert-verify": true,
              "servername": host,
              "network": "ws",
              "ws-opts": { "path": path, "headers": { "Host": host } },
              "udp": true
          };
      }

      // 4. è¾“å‡º 4 ä¸ªèŠ‚ç‚¹
      $done({
          proxies: [
              createProxy("ğŸ“± ç§»åŠ¨ | " + cm, cm),
              createProxy("ğŸŒ ç”µä¿¡ | " + ct, ct),
              createProxy("ğŸ“¶ è”é€š | " + cu, cu),
              createProxy("ğŸ¦• IPv6 | " + v6, v6)
          ]
      });

# ==================================
# 3. ç­–ç•¥ç»„
# ==================================
proxy-groups:
  - name: "ğŸš€ è‡ªåŠ¨ä¼˜é€‰"
    type: select
    use:
      - CF-Auto-Nodes

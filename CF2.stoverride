name: "Cloudflare ç»ˆæä¿åº•ç‰ˆ"
desc: "æœ¬åœ°é—­ç¯è¿è¡Œï¼Œå¼ºåˆ¶ç”ŸæˆèŠ‚ç‚¹ï¼Œæ— éœ€ä¸‹è½½"

# ==================================
# 1. é¦–é¡µç£è´´ (ç‚¹å‡»æµ‹é€Ÿ)
# ==================================
tiles:
  - name: CF-Speedtest
    title: Cloudflare å››ç½‘ä¼˜é€‰
    content: ç‚¹å‡»è¿è¡Œæµ‹é€Ÿ
    icon: network
    collapsed: false

script-providers:
  CF-Speedtest:
    interval: 0
    # âœ… ç»æ€ 1ï¼šä½¿ç”¨ Base64 ä¼ªè£… URLï¼Œæ— éœ€è”ç½‘ä¸‹è½½ï¼Œæ°¸ä¸æŠ¥é”™
    url: "data:text/javascript;base64,Ly8gUGxhY2Vob2xkZXI="
    
    content: |
      const url = "https://api.uouin.com/index.php/index/Cloudflare?key=123&time=" + Date.now();
      
      function getBest(list) {
          if(!list) return null;
          let v = list.filter(i => i.loss === "0.00%");
          if(v.length===0) return list[0];
          v.sort((a,b) => parseFloat(a.ping) - parseFloat(b.ping));
          return v[0];
      }

      $httpClient.get({url: url, timeout: 5000}, function(error, response, data) {
          // å³ä½¿å¤±è´¥ä¹Ÿå¼¹çª—æç¤ºï¼Œæ–¹ä¾¿è°ƒè¯•
          if (error) { 
              $done({title:"æµ‹é€Ÿå¤±è´¥", content:"æ— æ³•è¿æ¥ API", backgroundColor:"#FF3B30", icon:"xmark"}); 
              return; 
          }
          try {
              let d = JSON.parse(data).data;
              let cm = getBest(d.cmcc?.info);
              let ct = getBest(d.ctcc?.info);
              let cu = getBest(d.cucc?.info);
              let v6 = getBest(d.ipv6?.info);
              
              // å†™å…¥å­˜å‚¨
              if(cm) $persistentStore.write(cm.ip, "CF_IP_CM");
              if(ct) $persistentStore.write(ct.ip, "CF_IP_CT");
              if(cu) $persistentStore.write(cu.ip, "CF_IP_CU");
              if(v6) $persistentStore.write(v6.ip, "CF_IP_V6");
              
              let txt = "æ›´æ–°æˆåŠŸ\n";
              if(cm) txt += `ç§»:${cm.ip}\n`;
              if(ct) txt += `ç”µ:${ct.ip}\n`;
              if(v6) txt += `v6:${v6.ip.substring(0,10)}..`;
              
              $done({title:"ä¼˜é€‰å®Œæˆ", content: txt, backgroundColor:"#34C759", icon:"checkmark"});
          } catch(e) { 
              $done({title:"æ•°æ®é”™è¯¯", content: "è§£æå¼‚å¸¸", backgroundColor:"#FF3B30", icon:"exclamationmark"}); 
          }
      });

# ==================================
# 2. è‡ªåŠ¨èŠ‚ç‚¹ç”Ÿæˆ (å¼ºåˆ¶è¾“å‡º 4 ä¸ª)
# ==================================
proxy-providers:
  CF-Auto-Nodes:
    type: script
    interval: 300
    health-check: {enable: true, url: http://www.gstatic.com/generate_204, interval: 300}
    # âœ… ç»æ€ 2ï¼šåŒæ ·ä½¿ç”¨æœ¬åœ°åè®® URL
    url: "data:text/javascript;base64,Ly8gTm9kZSBHZW5lcmF0b3I="
    
    content: |
      // 1. å®šä¹‰ä¿åº•é»˜è®¤å€¼ (æ‚¨çš„åŸå§‹åŸŸå)
      var def = "cf.zhetengsha.eu.org";
      
      // 2. å°è¯•è¯»å– (è¯»ä¸åˆ°å°±ç”¨é»˜è®¤ï¼Œä¿è¯æœ‰å€¼)
      var cm = $persistentStore.read("CF_IP_CM");
      var ct = $persistentStore.read("CF_IP_CT");
      var cu = $persistentStore.read("CF_IP_CU");
      var v6 = $persistentStore.read("CF_IP_V6");

      // å¼ºåˆ¶å…œåº•
      if(!cm || cm.length < 7) cm = def;
      if(!ct || ct.length < 7) ct = def;
      if(!cu || cu.length < 7) cu = def;
      if(!v6 || v6.length < 7) v6 = def;

      // 3. æ‚¨çš„é…ç½® (ä¸¥è°¨å¯¹åº”æ‚¨çš„ VLESS æ ¼å¼)
      var uuid = "87d1bfd4-574e-4c96-ad42-0426f27461ff";
      var host = "_acme-challenge.2go.cloudns.be";
      var path = "/?ed=2560"; // è·¯å¾„å·²æ”¹ä¸ºæ‚¨çš„è¦æ±‚

      // 4. ç”Ÿæˆå‡½æ•°
      function createProxy(name, ip) {
          var finalIP = ip;
          // IPv6 å¿…é¡»åŠ  []
          if (ip.indexOf(":") > -1 && ip.indexOf("[") === -1) finalIP = "[" + ip + "]";
          
          return {
              "name": name,
              "type": "vless",
              "server": finalIP,
              "port": 443,
              "uuid": uuid,
              "tls": true,
              "skip-cert-verify": true,
              "servername": host,
              "network": "ws",
              "ws-opts": { 
                  "path": path, 
                  "headers": { "Host": host } 
              },
              "udp": true
          };
      }

      // 5. å¼ºåˆ¶è¾“å‡º 4 ä¸ªèŠ‚ç‚¹ (æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ)
      $done({
          proxies: [
              createProxy("ğŸ“± ç§»åŠ¨ | " + cm, cm),
              createProxy("ğŸŒ ç”µä¿¡ | " + ct, ct),
              createProxy("ğŸ“¶ è”é€š | " + cu, cu),
              createProxy("ğŸ¦• IPv6 | " + v6, v6)
          ]
      });

# ==================================
# 3. ç­–ç•¥ç»„
# ==================================
proxy-groups:
  - name: "ğŸš€ è‡ªåŠ¨ä¼˜é€‰"
    type: select
    use:
      - CF-Auto-Nodes
